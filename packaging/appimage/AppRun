#!/bin/bash
# AppRun - Entry point for Speak-to-AI AppImage

SELF=$(readlink -f "$0")
HERE=${SELF%/*}
export PATH="${HERE}/usr/bin:${PATH}"
export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"

# PulseAudio/PipeWire environment for audio recording
export PULSE_SERVER="${PULSE_SERVER:-unix:${XDG_RUNTIME_DIR}/pulse/native}"
export PULSE_RUNTIME_PATH="${PULSE_RUNTIME_PATH:-${XDG_RUNTIME_DIR}/pulse}"

CONFIG_DIR="${HOME}/.config/speak-to-ai"
mkdir -p "${CONFIG_DIR}"

# Check if running in CLI mode
is_cli_command() {
    for arg in "$@"; do
        case "$arg" in
            start|stop|toggle|status|transcript) return 0 ;;
        esac
    done
    return 1
}

# First launch setup (GUI mode only)
setup_first_launch() {
    if [ -f "${CONFIG_DIR}/config.yaml" ]; then
        return
    fi

    echo "First launch detected: Setting up configuration..."
    cp "${HERE}/config.yaml" "${CONFIG_DIR}/config.yaml"

    # Check hotkey support
    if command -v busctl >/dev/null 2>&1 && busctl --user status >/dev/null 2>&1; then
        echo "D-Bus session available - hotkeys supported"
    elif [ -r /dev/input/event0 ] 2>/dev/null; then
        echo "Input devices accessible - hotkeys supported"
    else
        echo "Warning: Hotkeys may not work without additional setup."
        echo "For GNOME/KDE: Ensure D-Bus session is running"
        echo "For other DEs: sudo usermod -a -G input $USER"
    fi
}

# Desktop integration
integrate_desktop() {
    local desktop_file="${HOME}/.local/share/applications/speak-to-ai.desktop"
    local icon_dir="${HOME}/.local/share/icons/hicolor/128x128/apps"

    if [ -f "$desktop_file" ]; then
        return
    fi

    # Skip if AppImageLauncher handles integration
    if command -v appimaged >/dev/null 2>&1 || command -v appimageupdatetool >/dev/null 2>&1; then
        return
    fi

    echo "Creating desktop menu integration..."
    mkdir -p "$(dirname "$desktop_file")" "$icon_dir"

    cat > "$desktop_file" << EOF
[Desktop Entry]
Name=Speak-to-AI
Comment=Offline speech-to-text for AI assistants
Exec="${SELF}" %U
Icon=speak-to-ai
Type=Application
Categories=Utility;Audio;Accessibility;
Terminal=false
StartupNotify=true
EOF
    chmod +x "$desktop_file"
    cp "${HERE}/io.github.ashbuk.speak-to-ai.png" "$icon_dir/speak-to-ai.png" 2>/dev/null || true
    command -v update-desktop-database >/dev/null 2>&1 && \
        update-desktop-database "${HOME}/.local/share/applications" 2>/dev/null || true
}

# Main
cd "${HERE}"

if is_cli_command "$@"; then
    [ ! -f "${CONFIG_DIR}/config.yaml" ] && cp "${HERE}/config.yaml" "${CONFIG_DIR}/config.yaml" 2>/dev/null || true
    exec "${HERE}/usr/bin/speak-to-ai" "$@"
else
    setup_first_launch
    integrate_desktop
    exec "${HERE}/usr/bin/speak-to-ai" --config "${CONFIG_DIR}/config.yaml" "$@"
fi
