name: Release AppImage

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
        default: '0.1.0'

permissions:
  contents: write
  actions: read

jobs:
  build-appimage:
    strategy:
      matrix:
        os: [ubuntu-22.04]
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.1'
        
    - name: Export CGO environment  
      run: |
        echo "=== Setting up CGO environment ==="
        echo "CGO_ENABLED=1" >> $GITHUB_ENV
        echo "CGO_CFLAGS=-I$PWD/lib" >> $GITHUB_ENV
        echo "CGO_LDFLAGS=-L$PWD/lib -lwhisper -lggml-cpu -lggml" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=$PWD/lib" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=$PWD/lib" >> $GITHUB_ENV
        
    # Temporarily disable Go modules cache due to tar extraction issues
    # - name: Cache Go modules  
    #   uses: actions/cache@v4
    #   with:
    #     path: |
    #       ~/.cache/go-build
    #       ~/go/pkg/mod
    #     key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
    #     restore-keys: |
    #       ${{ runner.os }}-go-
        
    - name: Debug - Show environment
      run: |
        echo "=== Environment Debug ==="
        echo "Go version: $(go version)"
        echo "Working directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        echo "Go mod contents:"
        cat go.mod
        echo "========================"
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          git \
          curl \
          wget \
          libayatana-appindicator3-dev \
          libgtk-3-dev \
          libglib2.0-dev \
          libdbus-1-dev \
          ffmpeg \
          alsa-utils \
          file \
          desktop-file-utils \
          xclip \
          wl-clipboard \
          xdotool \
          ydotool \
          libnotify-bin \
          imagemagick \
          make
          
    - name: Create application icon
      run: |
        # Create a simple icon if not exists
        if [ ! -f "icons/io.github.ashbuk.speak-to-ai.png" ]; then
          echo "Creating application icon..."
          mkdir -p icons
          # Create a simple microphone icon
          convert -size 256x256 xc:'#2196F3' \
            -fill white -draw "circle 128,128 128,48" \
            -fill '#1976D2' -pointsize 120 -gravity center \
            -annotate +0+0 "ðŸŽ¤" \
            icons/io.github.ashbuk.speak-to-ai.png
          echo "âœ… Icon created successfully"
        else
          echo "âœ… Icon already exists"
        fi
          
    - name: Build application
      run: |
        echo "=== Building application with Makefile ==="
        make all
        echo "Build successful, binary info:"
        ls -la speak-to-ai
        file speak-to-ai
        echo "========================"
          
    - name: Download Whisper model if not present
      run: |
        if [ ! -f "sources/language-models/small-q5_1.bin" ]; then
          echo "Downloading Whisper small-q5_1 model..."
          mkdir -p sources/language-models
          curl -fsSL "https://raw.githubusercontent.com/ggml-org/whisper.cpp/master/models/download-ggml-model.sh" | bash -s small-q5_1 || {
            echo "âŒ Failed to download small-q5_1 model"; exit 1;
          }
          mv ggml-small-q5_1.bin "sources/language-models/small-q5_1.bin"
          echo "Model downloaded, size: $(ls -lh sources/language-models/small-q5_1.bin)"
        fi


        
    - name: Debug - Pre-build status
      run: |
        echo "=== Pre-build Debug ==="
        echo "Library structure:"
        ls -la lib/
        echo "AppImage script exists:"
        ls -la bash-scripts/build-appimage.sh
        echo "========================"
        
    - name: Build AppImage
      env:
        APP_VERSION: ${{ github.event.inputs.version || github.ref_name }}
      run: |
        chmod +x packaging/appimage/build-appimage.sh
        bash -x packaging/appimage/build-appimage.sh
        
    - name: Verify AppImage
      run: |
        # Check if AppImage is executable and valid
        echo "Checking AppImage artifacts..."
        ls -lh dist/*.AppImage
        for appimage in dist/*.AppImage; do
          echo "Verifying: $appimage"
          chmod +x "$appimage"
          file "$appimage"
          # Check if it's a valid AppImage
          if "$appimage" --appimage-help > /dev/null 2>&1; then
            echo "âœ… Valid AppImage: $appimage"
          else
            echo "âš ï¸ AppImage validation failed for: $appimage"
          fi
        done
        
    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: speak-to-ai-appimage-${{ matrix.os }}
        path: |
          dist/*.AppImage
          !dist/tools/

  create-release:
    needs: [build-appimage]
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download AppImage artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: speak-to-ai-appimage-*
        path: ./artifacts/
        merge-multiple: true

    - name: Extract release notes
      id: extract_release_notes
      run: |
        VERSION=$(echo ${{ github.ref_name }} | sed 's/v//')
        awk -v version="$VERSION" '
          index($0, "## [" version "]") {
            in_section=1
            next
          }
          in_section && /^## / {
            exit
          }
          in_section {
            print
          }
        ' CHANGELOG.md > release_notes.md

        {
          echo "notes<<EOF"
          cat release_notes.md
          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./artifacts/*.AppImage
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}