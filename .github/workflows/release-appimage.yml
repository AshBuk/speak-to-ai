# Copyright (c) 2025 Asher Buk
# SPDX-License-Identifier: MIT

name: Release AppImage

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Only stable tags (v1.0.0), not RC (v1.0.0-rc.1)
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
        default: '0.1.0'

permissions:
  contents: write
  actions: read

jobs:
  build-appimage:
    strategy:
      matrix:
        os: [ubuntu-22.04]
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-appimage-${{ hashFiles('docker/Dockerfile.appimage', 'go.mod', 'go.sum') }}
        restore-keys: |
          ${{ runner.os }}-buildx-appimage-

    - name: Build AppImage via Docker
      env:
        APP_VERSION: ${{ github.event.inputs.version || github.ref_name }}
      run: |
        echo "=== Building AppImage via Docker (includes Vulkan SDK) ==="
        echo "Version: ${APP_VERSION}"
        docker buildx build \
          -f docker/Dockerfile.appimage \
          --build-arg APP_VERSION="${APP_VERSION}" \
          --target artifacts \
          --cache-from type=local,src=/tmp/.buildx-cache \
          --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
          --output type=local,dest=dist .
        echo "=== Build completed ==="
        ls -la dist/

    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache
        
    - name: Verify AppImage
      run: |
        # Check if AppImage is executable and valid
        echo "Checking AppImage artifacts..."
        ls -lh dist/*.AppImage
        for appimage in dist/*.AppImage; do
          echo "Verifying: $appimage"
          chmod +x "$appimage"
          file "$appimage"
          # Check if it's a valid AppImage
          if "$appimage" --appimage-help > /dev/null 2>&1; then
            echo "✅ Valid AppImage: $appimage"
          else
            echo "⚠️ AppImage validation failed for: $appimage"
          fi
        done
        
    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: speak-to-ai-appimage-${{ matrix.os }}
        path: |
          dist/*.AppImage
          !dist/tools/

  create-release:
    needs: [build-appimage]
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download AppImage artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: speak-to-ai-appimage-*
        path: ./artifacts/
        merge-multiple: true

    - name: Extract release notes
      id: extract_release_notes
      run: |
        VERSION=$(echo ${{ github.ref_name }} | sed 's/v//')
        awk -v version="$VERSION" '
          index($0, "## [" version "]") {
            in_section=1
            next
          }
          in_section && /^## / {
            exit
          }
          in_section {
            print
          }
        ' CHANGELOG.md > release_notes.md

        {
          echo "notes<<EOF"
          cat release_notes.md
          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./artifacts/*.AppImage
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}