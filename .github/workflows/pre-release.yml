# Copyright (c) 2025 Asher Buk
# SPDX-License-Identifier: MIT

name: Pre-release Validation

# Triggered by RC tags (v1.0.0-rc.1, v2.0.0-rc.2, etc.)
# Builds ALL artifacts without publishing to verify release readiness

on:
  push:
    tags:
      - 'v*-rc.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to validate (e.g., 1.7.0)'
        required: true

permissions:
  contents: read
  actions: read

jobs:
  # Build AppImage
  build-appimage:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-appimage-${{ hashFiles('docker/Dockerfile.appimage', 'go.mod', 'go.sum') }}
          restore-keys: |
            ${{ runner.os }}-buildx-appimage-

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Extract version from RC tag: v1.7.0-rc.1 -> 1.7.0
            VERSION=$(echo "${GITHUB_REF_NAME}" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+)-rc\.[0-9]+$/\1/')
            echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Build AppImage via Docker
        env:
          APP_VERSION: v${{ steps.version.outputs.VERSION }}
        run: |
          echo "=== Building AppImage for validation ==="
          echo "Version: ${APP_VERSION}"
          docker buildx build \
            -f docker/Dockerfile.appimage \
            --build-arg APP_VERSION="${APP_VERSION}" \
            --target artifacts \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --output type=local,dest=dist .

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Verify AppImage
        run: |
          echo "Checking AppImage artifacts..."
          ls -lh dist/*.AppImage
          for appimage in dist/*.AppImage; do
            chmod +x "$appimage"
            if "$appimage" --appimage-help > /dev/null 2>&1; then
              echo "✅ Valid AppImage: $appimage"
            else
              echo "❌ AppImage validation failed: $appimage"
              exit 1
            fi
          done

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage-rc
          path: dist/*.AppImage
          retention-days: 1

  # Build Fedora SRPM
  build-srpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: dnf install -y golang rpm-build rpmlint curl glibc-langpack-en

      - name: Vendor Go dependencies
        run: go mod vendor

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=$(echo "${GITHUB_REF_NAME}" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+)-rc\.[0-9]+$/\1/')
            echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Update spec version
        run: |
          sed -i "s/^%global app_version.*/%global app_version     ${{ steps.version.outputs.VERSION }}/" \
            packaging/fedora/speak-to-ai.spec

      - name: Lint spec file
        run: rpmlint -r packaging/fedora/.rpmlintrc packaging/fedora/speak-to-ai.spec

      - name: Create SRPM
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp packaging/fedora/speak-to-ai.spec ~/rpmbuild/SPECS/

          VERSION="${{ steps.version.outputs.VERSION }}"
          tar --transform "s,^,speak-to-ai-${VERSION}/," \
              --exclude='.git' \
              --exclude='build' \
              --exclude='dist' \
              --exclude='lib' \
              -czf ~/rpmbuild/SOURCES/speak-to-ai-${VERSION}-vendored.tar.gz \
              cmd/ config/ hotkeys/ audio/ whisper/ output/ websocket/ internal/ \
              vendor/ \
              go.mod go.sum \
              Makefile LICENSE README.md CHANGELOG.md \
              config.yaml \
              io.github.ashbuk.speak-to-ai.desktop \
              io.github.ashbuk.speak-to-ai.appdata.xml \
              icons/ docs/ packaging/

          WHISPER_VERSION=$(grep -E '^%global whisper_version' packaging/fedora/speak-to-ai.spec | awk '{print $3}')
          curl -L -o ~/rpmbuild/SOURCES/whisper-cpp-${WHISPER_VERSION}.tar.gz \
            "https://github.com/ggml-org/whisper.cpp/archive/refs/tags/v${WHISPER_VERSION}.tar.gz"

          rpmbuild -bs ~/rpmbuild/SPECS/speak-to-ai.spec
          echo "✅ SRPM built successfully"

      - name: Upload SRPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: srpm-rc
          path: ~/rpmbuild/SRPMS/*.src.rpm
          retention-days: 1

  # Validate Arch PKGBUILD
  validate-arch:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=$(echo "${GITHUB_REF_NAME}" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+)-rc\.[0-9]+$/\1/')
            echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Update PKGBUILD version
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cd packaging/arch
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

      - name: Generate .SRCINFO and lint
        uses: docker://archlinux:latest
        with:
          entrypoint: /bin/bash
          args: |
            -c "
              pacman -Syu --noconfirm pacman-contrib namcap
              useradd -m builder
              chown -R builder:builder packaging/arch
              cd packaging/arch
              su builder -c 'makepkg --printsrcinfo > .SRCINFO'
              echo '=== Linting PKGBUILD ==='
              namcap PKGBUILD
              echo '✅ Arch validation passed'
            "

  # Summary job
  pre-release-summary:
    needs: [build-appimage, build-srpm, validate-arch]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "========================================"
          echo "      PRE-RELEASE VALIDATION SUMMARY"
          echo "========================================"
          echo ""
          echo "AppImage:      ${{ needs.build-appimage.result }}"
          echo "Fedora SRPM:   ${{ needs.build-srpm.result }}"
          echo "Arch PKGBUILD: ${{ needs.validate-arch.result }}"
          echo ""

          if [ "${{ needs.build-appimage.result }}" = "success" ] && \
             [ "${{ needs.build-srpm.result }}" = "success" ] && \
             [ "${{ needs.validate-arch.result }}" = "success" ]; then
            echo "========================================"
            echo "✅ ALL BUILDS PASSED!"
            echo ""
            echo "You can now create the production release:"
            VERSION=$(echo "${GITHUB_REF_NAME}" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+)-rc\.[0-9]+$/\1/')
            echo "  git tag v${VERSION}"
            echo "  git push origin v${VERSION}"
            echo "========================================"
          else
            echo "========================================"
            echo "❌ SOME BUILDS FAILED!"
            echo "Fix the issues and create a new RC tag."
            echo "========================================"
            exit 1
          fi
